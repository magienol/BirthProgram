"use strict";

var _input = require("@dhis2-ui/input");
var _react = require("@testing-library/react");
var _userEvent = require("@testing-library/user-event");
var _enzyme = require("enzyme");
var _react2 = _interopRequireDefault(require("react"));
var _menuDivider = require("../../menu-divider/menu-divider.js");
var _menuItem = require("../../menu-item/menu-item.js");
var _menuSectionHeader = require("../../menu-section-header/menu-section-header.js");
var _menu = require("../menu.js");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
describe('Menu Component', () => {
  const menuDataTest = 'data-test-menu';
  const menuItemDataTest = 'data-test-menu-item';
  const dividerDataTest = 'data-test-menu-divider';
  it('Menu and menu items have aria attributes', () => {
    const wrapper = (0, _enzyme.mount)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement(_menuSectionHeader.MenuSectionHeader, {
      label: "Header"
    }), /*#__PURE__*/_react2.default.createElement(_menuDivider.MenuDivider, {
      dataTest: dividerDataTest
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item"
    })));
    const menuElement = wrapper.find({
      'data-test': menuDataTest
    });
    const menuItem = wrapper.find({
      'data-test': menuItemDataTest
    });
    const menuDivider = wrapper.find({
      'data-test': dividerDataTest
    });
    expect(menuElement.prop('role')).toBe('menu');
    expect(menuItem.childAt(0).props().role).toBe('menuitem');
    expect(menuItem.childAt(0).prop('aria-label')).toBe('Menu item');
    expect(menuDivider.find('[role="separator"]').exists()).toBe(true);
  });
  it('Empty menu has role menu', () => {
    const menuDataTest = 'data-test-menu';
    const wrapper = (0, _enzyme.mount)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }));
    const menuElement = wrapper.find({
      'data-test': menuDataTest
    });
    expect(menuElement.prop('role')).toBe('menu');
  });
  it('can handle focus of first focusable element when tabbed to', async () => {
    const {
      getByRole,
      getByText
    } = (0, _react.render)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement(_menuSectionHeader.MenuSectionHeader, {
      label: "Header"
    }), /*#__PURE__*/_react2.default.createElement(_menuDivider.MenuDivider, {
      dataTest: dividerDataTest
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item 1"
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item 2"
    })));
    const menu = getByRole('menu');
    const divider = getByRole('separator');
    const header = getByText(/Header/i);
    const menuItem1 = getByText(/Menu item 1/i);
    const menuItem2 = getByText(/Menu item 2/i);
    const user = _userEvent.userEvent.setup();
    expect(menu).not.toHaveFocus();
    await user.keyboard('{Tab}');
    // check if LI parent node has focus or not
    // headers and dividers do not receive focus
    expect(header.parentNode.parentNode).not.toHaveFocus();
    expect(divider.parentNode.parentNode).not.toHaveFocus();
    expect(menuItem2.parentNode.parentNode).not.toHaveFocus();
    expect(menuItem1.parentNode.parentNode).toHaveFocus();
  });
  it('can handle arrow down key navigation', async () => {
    const {
      getByText
    } = (0, _react.render)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement(_menuSectionHeader.MenuSectionHeader, {
      label: "Header"
    }), /*#__PURE__*/_react2.default.createElement(_menuDivider.MenuDivider, {
      dataTest: dividerDataTest
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item 1"
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item 2"
    })));
    const menuItem1 = getByText(/Menu item 1/i);
    const menuItem2 = getByText(/Menu item 2/i);
    const user = _userEvent.userEvent.setup();
    expect(document.body).toHaveFocus();

    // await fireEvent.focus(getByRole('menu'))
    await user.keyboard('{Tab}');
    expect(menuItem1.parentNode.parentNode).toHaveFocus();
    // simulate arrowDown press
    await user.keyboard('{ArrowDown}');
    expect(menuItem1.parentNode.parentNode).not.toHaveFocus();
    expect(menuItem2.parentNode.parentNode).toHaveFocus();
    await user.keyboard('{ArrowDown}');
    expect(menuItem1.parentNode.parentNode).toHaveFocus();
    expect(menuItem2.parentNode.parentNode).not.toHaveFocus();
  });
  it('can handle arrow up key navigation', async () => {
    const {
      getByText
    } = (0, _react.render)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement(_menuSectionHeader.MenuSectionHeader, {
      label: "Header"
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item 1"
    }), /*#__PURE__*/_react2.default.createElement(_menuDivider.MenuDivider, {
      dataTest: dividerDataTest
    }), /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      dataTest: menuItemDataTest,
      label: "Menu item 2"
    })));
    const menuItem1 = getByText(/Menu item 1/i);
    const menuItem2 = getByText(/Menu item 2/i);
    const user = _userEvent.userEvent.setup();
    await user.tab();
    expect(menuItem1.parentNode.parentNode).toHaveFocus();

    // simulate arrowUp press
    await user.keyboard('{ArrowUp}');
    expect(menuItem1.parentNode.parentNode).not.toHaveFocus();
    expect(menuItem2.parentNode.parentNode).toHaveFocus();
    await user.keyboard('{ArrowUp}');
    expect(menuItem1.parentNode.parentNode).toHaveFocus();
    expect(menuItem2.parentNode.parentNode).not.toHaveFocus();
  });
  it('can handle space and enter key presses for clickable menu items', async () => {
    const onClick = jest.fn();
    const {
      getByText
    } = (0, _react.render)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      onClick: onClick,
      value: "myValue",
      label: "Click menu item"
    })));
    const clickableItem = getByText(/Click menu item/i);
    const user = _userEvent.userEvent.setup();
    await user.tab();
    expect(clickableItem.parentNode.parentNode).toHaveFocus();
    await user.keyboard('[Space]');
    expect(onClick).toHaveBeenCalledTimes(1);
    await user.keyboard('{Enter}');
    expect(onClick).toHaveBeenCalledTimes(2);
  });
  it('can handle non MenuItem components', async () => {
    const onClick = jest.fn();
    const {
      getByText
    } = (0, _react.render)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement("span", {
      role: "menuitem",
      onClick: onClick
    }, "Span 1"), /*#__PURE__*/_react2.default.createElement("li", {
      tabIndex: -1
    }, /*#__PURE__*/_react2.default.createElement("a", {
      href: "#",
      role: "menuitem"
    }, "Link 2")), /*#__PURE__*/_react2.default.createElement("li", null, /*#__PURE__*/_react2.default.createElement("span", {
      onClick: onClick
    }, "Span 2"))));
    const nonListMenuItem = getByText(/span 1/i);
    const listMenuItem = getByText(/link 2/i);
    const plainListItem = getByText(/span 2/i);

    // all children must be list items
    expect(nonListMenuItem.parentElement.nodeName).toBe('LI');
    const user = _userEvent.userEvent.setup();
    await user.tab();
    expect(nonListMenuItem.parentElement).toHaveFocus();
    expect(nonListMenuItem.parentElement.tabIndex).toBe(0);
    expect(onClick).toHaveBeenCalledTimes(0);
    await user.keyboard(' ');
    expect(onClick).toHaveBeenCalledTimes(1);
    await user.keyboard('{ArrowDown}');
    expect(listMenuItem.parentElement).toHaveFocus();
    await user.keyboard('{ArrowDown}');
    expect(nonListMenuItem.parentElement).toHaveFocus();
    // non menu items do not receive focus
    expect(plainListItem.parentElement).not.toHaveFocus();
  });
  it('does not hijack input change value if space entered [bug]', async () => {
    const onChange = jest.fn();
    const {
      getByPlaceholderText
    } = (0, _react.render)(/*#__PURE__*/_react2.default.createElement(_menu.Menu, {
      dataTest: menuDataTest,
      dense: false
    }, /*#__PURE__*/_react2.default.createElement(_menuItem.MenuItem, {
      value: "myValue",
      label: "Click menu item"
    }), /*#__PURE__*/_react2.default.createElement(_input.Input, {
      onChange: onChange,
      placeholder: "test"
    })));
    const inputField = getByPlaceholderText('test');
    const user = _userEvent.userEvent.setup();
    await inputField.focus();
    await user.type(inputField, 't');
    await user.type(inputField, 'e');
    await user.type(inputField, ' ');
    await user.type(inputField, 'st');
    expect(inputField.value).toBe('te st');
    expect(onChange).toHaveBeenCalled();
  });
});